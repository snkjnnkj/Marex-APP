{"version":3,"file":"useLogin.js","sources":["stores/useLogin.js"],"sourcesContent":["import {ref} from 'vue'\r\nimport {ip} from \"@/stores/ipconfig.js\";\r\nimport {useCountDown} from '../utils/countDown.js'\r\nimport {getMathRandom} from '../utils/random.js'\r\nimport {formatDateTime} from '../utils/CreateDate.js'\r\n\r\nconst {countdown: countdown1, handleClick: handleClick1} = useCountDown()\r\n\r\n//储存账号\r\nconst mailbox = ref('264201536@qq.com')\r\n//登录的加载动画\r\nconst isLoading = ref(false)\r\n//粗存用户登录信息\r\nconst user = ref([])\r\n//储存token\r\nconst token = ref();\r\n//储存用户的cookes信息\r\nconst cookesUser = ref()\r\n//储存后端返回的验证码\r\nconst code = ref()\r\n//储存用户输入的验证码\r\nconst codeInput = ref()\r\n\r\n// 邮箱正则验证函数\r\nfunction validateEmail(email) {\r\n    const regex = /^[a-zA-Z0-9._%+-]+@(qq|163|126|yeah)\\.(com|net)$/i;\r\n    return regex.test(email);\r\n}\r\n\r\n/*登录验证邮箱是否正确*/\r\nfunction verificationMailbox() {\r\n    // 邮箱验证\r\n    if (!mailbox.value) {\r\n        uni.showToast({\r\n            title: '邮箱不能为空',  // 提示内容\r\n            icon: 'none',     // 图标类型（success/loading/none）\r\n            duration: 2000,      // 显示时长（毫秒）\r\n            mask: true           // 是否显示透明蒙层\r\n        })\r\n        return false\r\n    } else if (!validateEmail(mailbox.value)) {\r\n        uni.showToast({\r\n            title: '请输入正确的邮箱格式',  // 提示内容\r\n            icon: 'none',     // 图标类型（success/loading/none）\r\n            duration: 2000,      // 显示时长（毫秒）\r\n            mask: true           // 是否显示透明蒙层\r\n        })\r\n        return false\r\n    } else {\r\n        return true\r\n    }\r\n}\r\n\r\n//封装一个post请求\r\nasync function getRegisterCode(data) {\r\n    return await uni.request({\r\n        url: ip + '/app/getCode',\r\n        method: 'POST',\r\n        data\r\n    });\r\n}\r\n\r\n/*获取验证码*/\r\nasync function RegistrationVerificationCode() {\r\n    try {\r\n        let res = await getRegisterCode({\r\n            mailbox: mailbox.value,\r\n            content: `用于<a href=\"https://xiaoli.icu\">报修云</a>平台的安全验证，5分钟内有效，若非本人操作请忽略此消息。`\r\n        })\r\n        if (res.data.code === 200) {\r\n            code.value = res.data.data\r\n            console.log(code.value)\r\n        }\r\n    } catch (error) {\r\n        console.error(error)\r\n    }\r\n}\r\n\r\n/* 发送验证码，并且倒计时 */\r\nfunction getLoginCode() {\r\n    handleClick1()\r\n    RegistrationVerificationCode()\r\n    uni.showToast({\r\n        title: '验证码发送成功',\r\n        icon: 'none'\r\n    });\r\n}\r\n\r\n/*封装一个向数据库写入注册信息的函数*/\r\nasync function add(data) {\r\n    return await uni.request({\r\n        url: ip + '/app/addUser',\r\n        method: 'GET',\r\n        data\r\n    });\r\n}\r\n\r\n/*写入*/\r\nasync function WriteToTheDatabase() {\r\n    let x = getMathRandom()\r\n    let date = formatDateTime()\r\n    return await add({\r\n        username: x,\r\n        email: mailbox.value,\r\n        phone: '',\r\n        avatar: 'https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132',\r\n        created_at: date,\r\n        updated_at: date,\r\n    })\r\n}\r\n\r\n/*验证验证码*/\r\nasync function verificationCode() {\r\n    if (codeInput.value === code.value) {\r\n        uni.showToast({\r\n            title: '验证成功',\r\n            icon: 'none'\r\n        });\r\n        const res = await WriteToTheDatabase()\r\n        console.log(res.data.data[0])\r\n        console.log(res.data.data)\r\n        uni.setStorageSync('user', res.data.data[0] || res.data.data);\r\n        home()\r\n    } else {\r\n        uni.showToast({\r\n            title: '验证失败',\r\n            icon: 'none'\r\n        });\r\n    }\r\n}\r\n\r\n/*确定验证邮箱*/\r\nfunction verification() {\r\n    const mailboxTrue = verificationMailbox()\r\n    if (mailboxTrue) {\r\n        uni.navigateTo({\r\n            url: '/pages/code/code',\r\n        });\r\n    }\r\n}\r\n\r\n// 进入首页\r\nfunction home() {\r\n    uni.switchTab({\r\n        url: '/pages/index/index'\r\n    });\r\n}\r\n\r\n/*调用微信登录接口*/\r\nconst wechatLogin = async () => {\r\n    try {\r\n        isLoading.value = true\r\n        // 1. 获取微信code（正确用法）\r\n        const loginRes = await new Promise((resolve, reject) => {\r\n            uni.login({\r\n                provider: 'weixin',\r\n                success: resolve,\r\n                fail: reject\r\n            });\r\n        });\r\n\r\n        // 2. 获取用户信息（正确用法）\r\n        const userRes = await new Promise((resolve, reject) => {\r\n            uni.getUserInfo({\r\n                provider: 'weixin',\r\n                success: resolve,\r\n                fail: reject\r\n            });\r\n        });\r\n        // 4. 发送请求到后端\r\n        const requestRes = await uni.request({\r\n            url: ip + '/app/wechat-login',\r\n            method: 'POST',\r\n            data: {\r\n                code: loginRes.code,\r\n                encryptedData: userRes.encryptedData,\r\n                iv: userRes.iv\r\n            }\r\n        });\r\n        if (requestRes.data.code === 200) {\r\n            user.value = requestRes.data.user\r\n            console.log(user.value)\r\n            token.value = requestRes.data.token\r\n            uni.setStorageSync('user', user.value);\r\n            home()\r\n            uni.showToast({\r\n                title: '登录成功',\r\n                icon: 'none'\r\n            });\r\n            isLoading.value = false\r\n        }\r\n\r\n    } catch (error) {\r\n        isLoading.value = false\r\n        console.error('登录流程异常:', error);\r\n        uni.showToast({\r\n            title: '登录失败,请检查网络',\r\n            icon: 'none'\r\n        });\r\n    }\r\n}\r\n\r\n//读取cookes\r\nfunction getUserInfo() {\r\n    cookesUser.value = uni.getStorageSync('user');\r\n}\r\n\r\n/*确认微信登录*/\r\nfunction WxChatLogin() {\r\n    //如果点击确定就调用微信登录函数\r\n    uni.showModal({\r\n        title: '提示', // 标题（可选）\r\n        content: '确定要使用微信账号进行登录或注册吗？', // 内容（可选）\r\n        confirmText: '确定', // 确认按钮文字（可选，默认\"确定\"）\r\n        cancelText: '取消', // 取消按钮文字（可选，默认\"取消\"）\r\n        success: async (res) => { // 用户点击后的回调\r\n            if (res.confirm) {\r\n                await wechatLogin()\r\n                console.log('用户点击了确定')\r\n            } else if (res.cancel) {\r\n                console.log('用户点击了取消')\r\n            }\r\n        }\r\n    })\r\n}\r\n\r\n//退出登录\r\nfunction outWxChatLogin() {\r\n    uni.removeStorageSync('user')\r\n    cookesUser.value = []\r\n    uni.redirectTo({\r\n        url: '/pages/Login/Login'\r\n    });\r\n    uni.showToast({\r\n        title: '登出成功',\r\n        icon: 'none'\r\n    });\r\n}\r\n\r\nexport function useLogin() {\r\n    getUserInfo() //先读取一次cookes\r\n    return {\r\n        mailbox,\r\n        isLoading,\r\n        verification,\r\n        wechatLogin,\r\n        WxChatLogin,\r\n        getUserInfo,\r\n        cookesUser,\r\n        home,\r\n        outWxChatLogin,\r\n        RegistrationVerificationCode,\r\n        verificationCode,\r\n        countdown1,\r\n        getLoginCode,\r\n        codeInput\r\n    }\r\n}"],"names":["useCountDown","ref","uni","ip","getMathRandom","formatDateTime"],"mappings":"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"}